<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
 <mapper namespace="QnADAO">
 	<resultMap type="QnA" id="QnAResult">
 		<id property="qna_num" column="QNA_NUM"/>
 		<result property="qna_title" column="QNA_TITLE"/>
 		<result property="qna_title_classification" column="QNA_TITLE_CLASSIFICATION" javaType="String"/>
 		<result property="qna_content" column="QNA_CONTENT"/>
 		<result property="qna_writetime" column="QNA_WRITETIME"/>
 		<result property="qna_updatetime" column="QNA_UPDATETIME"/> 		
 		<result property="qna_hit" column="QNA_HIT" />
 		<result property="upload_path" column="UPLOAD_PATH" />
 		<result property="store_file_name" column="STORE_FILE_NAME" />
 		<result property="upload_file_name" column="UPLOAD_FILE_NAME" />	
 		<association property="member" javaType="Member">
 			<id property="member_code" column="MEMBER_CODE"/>
 			<result property="member_id" column="MEMBER_ID"/>
 		</association>
 	</resultMap>
 	
 	
 	<sql id="QnAsearch">
	 <if test="searchType != null">
	  <if test="searchType == 't'.toString()">AND qna_title like '%' || #{keyword} || '%'</if>
	  <if test="searchType == 'c'.toString()">AND qna_content like '%' || #{keyword} || '%'</if>
	  <if test="searchType == 'w'.toString()">AND member_id like '%' || #{keyword} || '%'</if>
	  <if test="searchType == 'tc'.toString()">AND (qna_title like '%' || #{keyword} || '%') OR (qna_content like '%' || #{keyword} || '%')</if>
	 </if>
	</sql>
	
	<sql id="MyQnAsearch">
	 <if test="searchType != null">
	  <if test="searchType == 't'.toString()">AND qna_title like '%' || #{scri.keyword} || '%'</if>
	  <if test="searchType == 'c'.toString()">AND qna_content like '%' || #{scri.keyword} || '%'</if>
	 </if>
	</sql>
	
	
 	

 	<!-- 전체 QnA 개수 조회 -->
 	<select id="getQnANum" resultType="int">
 		SELECT COUNT(qna_num) FROM cafehi_qna
 		WHERE qna_num > 0	
 	</select>
 	
 	<!-- 검색 조건 QnA 개수 조회 -->
 	<select id="getQnASearchNum" resultType="int">
 		SELECT COUNT(qna_num) FROM cafehi_qna cq, cafehi_member cm
 		WHERE	
 		 <![CDATA[
 		 qna_num > 0
 		]]>
 		AND cq.member_code = cm.member_code
 		<include refid="QnAsearch"></include>
 	</select>
 	
 	
 	<!-- 나의 QnA 개수 조회 -->
 	<select id="getMyQnASearchNum" parameterType="map" resultType="int">
 		SELECT COUNT(qna_num) FROM cafehi_qna cq, cafehi_member cm
 		WHERE	
 		 <![CDATA[
 		 qna_num > 0
 		]]>
 		AND cq.member_code = cm.member_code AND cm.member_code = #{member_code}
 		 <if test="scri.searchType != null">
	  		<if test="scri.searchType == 't'.toString()">AND qna_title like '%' || #{scri.keyword} || '%'</if>
	  		<if test="scri.searchType == 'c'.toString()">AND qna_content like '%' || #{scri.keyword} || '%'</if>
	 	 </if>
 	</select>
	
	<!-- 검색 + 페이징 리스트 -->
	<select id="getQnAListSearch" resultMap="QnAResult"
			parameterType="SearchCriteria">
	SELECT qna_num, qna_title,qna_title_classification, qna_content, qna_writetime, qna_hit, member_id
	FROM 
	
	(
    SELECT qna_num, qna_title,qna_title_classification, qna_content, qna_writetime, qna_hit, cm.member_id,
        row_number() OVER(ORDER BY qna_num DESC) as rNum
    FROM cafehi_qna cq, cafehi_member cm
    WHERE cq.member_code = cm.member_code <include refid="QnAsearch"></include> 
    ) cqm
    
	WHERE rNum BETWEEN #{rowStart} AND #{rowEnd}
	ORDER BY qna_num DESC
		
	</select>
		
	<select id="getMyQnAListSearch" resultType="QnA"
			parameterType="map" >
	SELECT qna_num, qna_title,qna_title_classification, qna_content, qna_writetime, qna_hit, member_id
	FROM 
	
	(
    SELECT qna_num, qna_title,qna_title_classification, qna_content, qna_writetime, qna_hit, cm.member_code, cm.member_id,
        row_number() OVER(ORDER BY qna_num DESC) as rNum
    FROM cafehi_qna cq, cafehi_member cm
    WHERE cq.member_code = cm.member_code AND cm.member_code = #{member_code} 
     
     <if test="scri.searchType != null">
	  		<if test="scri.searchType == 't'.toString()">AND qna_title like '%' || #{scri.keyword} || '%'</if>
	  		<if test="scri.searchType == 'c'.toString()">AND qna_content like '%' || #{scri.keyword} || '%'</if>
	 </if>
     
    ) cqm
    
	WHERE rNum BETWEEN #{scri.rowStart} AND #{scri.rowEnd}
	ORDER BY qna_num DESC
	
	</select>

		
	
	



	<!-- 조회수 갱신 -->
	<update id="updateHit" parameterType="QnA">
		UPDATE cafehi_qna
		SET qna_hit = qna_hit + 1
		WHERE qna_num = #{qna_num}
	</update>

	<!-- QnA 조회 -->
	<select id="getQnA" resultMap="QnAResult">
		SELECT  * FROM(
		SELECT q.qna_num, q.qna_title, q.qna_title_classification, q.qna_content, q.qna_writetime, q.qna_hit, m.member_id, q.upload_path, q.store_file_name, q.upload_file_name FROM cafehi_qna q, cafehi_member m WHERE m.member_code = q.member_code
		)
		  WHERE qna_num=#{qna_num}
	</select>
	
	<!-- 내가 작성한 QnA 조회 -->
	<select id="getMyQnA" parameterType="hashMap" resultType="QnA">
		
		SELECT *
		FROM(
		SELECT rownum rn, qna_num, qna_title, qna_content, qna_writetime, qna_hit, upload_path, store_file_name, res.member_id, qna_title_classification FROM 
		(SELECT ma.member_auth_code, ma.member_code, ma.member_auth, mem.member_id FROM cafehi_member mem, cafehi_member_auth ma
		WHERE mem.member_code = ma.member_code and ma.member_code = #{member_code}) res, (SELECT * FROM cafehi_qna ORDER BY qna_num DESC) qna
		WHERE res.member_code = qna.member_code)
		 <![CDATA[
	 			WHERE rn > (#{cri.pageNum} -1) * #{cri.amount} AND rn <= #{cri.pageNum} * #{cri.amount}
	 		]]>
		
	</select>
	
	<!-- 모든 회원의 QnA 조회  -->
	<select id="MemberAllQnA" parameterType="hashMap" resultMap="QnAResult">
		SELECT * FROM (
		
		SELECT rownum rn, qna_num, qna_title, qna_content, qna_writetime, qna_hit, upload_path, store_file_name, member_id, qna_title_classification FROM(
		SELECT cq.qna_num, cq.qna_title, cq.qna_content, cq.qna_writetime, cq.qna_hit, cq.upload_path, cq.store_file_name, cm.member_id, cq.qna_title_classification 
		FROM cafehi_qna cq, cafehi_member cm, cafehi_member_auth cma 
		WHERE cm.member_code = cma.member_code AND cm.member_code = cq.member_code AND cma.member_auth = #{role_user} 
        ORDER BY qna_num DESC )
		
		)
		 <![CDATA[
	 			WHERE rn > (#{cri.pageNum} -1) * #{cri.amount} AND rn <= #{cri.pageNum} * #{cri.amount}
	 		]]>
	 	
		
	</select>
	
	

 	
 	<!-- 회원 전체 QnA 개수 조회 -->
 	<select id="getMemberQnANum" resultType="int">
 		SELECT COUNT(*) FROM cafehi_qna cq, cafehi_member_auth cma
 		WHERE cq.member_code = cma.member_code 
 		AND cma.member_auth = #{role_user}
 	</select>
 	
  	
	
	<insert id="insertQnA" parameterType="QnA">
		INSERT INTO cafehi_qna (qna_num, qna_title, qna_title_classification, qna_writetime, qna_updatetime, qna_hit, member_code , qna_content, upload_path, store_file_name, upload_file_name)
		VALUES(seq_qna.nextval, #{qna_title}, #{qna_title_classification}, #{qna_writetime}, #{qna_updatetime}, #{qna_hit}, #{member.member_code}, #{qna_content}, #{upload_path}, #{store_file_name}, #{upload_file_name})
	</insert>
	
	<!-- QnA 수정 -->
	<update id="updateQnA" parameterType="QnA">
		UPDATE cafehi_qna 
		SET qna_title=#{qna_title}, qna_title_classification=#{qna_title_classification}, qna_content=#{qna_content}, upload_path=#{upload_path}, store_file_name=#{store_file_name}, upload_file_name=#{upload_file_name} WHERE qna_num=#{qna_num}
	</update>
	
	<!-- QnA 삭제 -->
	<delete id="deleteQnA" parameterType="QnA">
		DELETE FROM cafehi_qna WHERE qna_num=#{qna_num}
	</delete>	
 	
 	
 </mapper>